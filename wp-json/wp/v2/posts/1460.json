{"id":1460,"date":"2022-07-10T17:35:08","date_gmt":"2022-07-10T15:35:08","guid":{"rendered":"https:\/\/www.nagekar.com\/?p=1460"},"modified":"2022-07-10T17:35:09","modified_gmt":"2022-07-10T15:35:09","slug":"setting-modsecurity-core-rule-set","status":"publish","type":"post","link":"https:\/\/nagekar.com\/2022\/07\/setting-modsecurity-core-rule-set.html","title":{"rendered":"Setting Up ModSecurity + OWASP Core Rule Set + Nginx On AWS EC2"},"content":{"rendered":"<p>ModSecurity is a web application firewall. It can protect your web application from preying eyes of vulnerability scanners and attackers. It is extremely customizable, and when paired with OWASP&#8217;s Core Rule Set, covers quite a lot of web technologies and frameworks.<\/p>\n<p>In this article, we&#8217;ll set up ModSecurity on an AWS EC2 Server running Nginx web server.<\/p>\n\n\n<p>Table of contents<\/p>\n\n\n\n<ul class=\"wp-block-list\"><li><a href=\"#set-up-nginx\" data-type=\"internal\" data-id=\"#set-up-nginx\">Set up Nginx on Ubuntu server<\/a><\/li><li><a href=\"#set-up-modsecurity\">Set up ModSecurity<\/a><\/li><li><a href=\"#set-up-connector\">Set up ModSecurity &lt;-> Nginx connector<\/a><\/li><li><a href=\"#load-modsecurity\">Loading ModSecurity module in Nginx<\/a><\/li><li><a href=\"#set-up-crs\">Set up OWASP Core Rule Set<\/a><\/li><li><a href=\"#turn-on-live\">Turn on ModSecurity in live mode and test XSS payload<\/a><\/li><\/ul>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"set-up-nginx\">Set up Nginx on Ubuntu server<\/h2>\n\n\n\n<p>For this tutorial, we&#8217;re using AWS LightSail&#8217;s Ubuntu image. Choose any instance size depending on your requirements. I&#8217;ll choose a 40$ \/ Month instance with 8GB RAM and 2vCPUs just so that the compilation of ModSecurity is faster.<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" decoding=\"async\" width=\"616\" height=\"1024\" src=\"https:\/\/www.nagekar.com\/wp-content\/uploads\/2022\/06\/image-1-616x1024.png\" alt=\"\" class=\"wp-image-1550\" srcset=\"https:\/\/nagekar.com\/wp-content\/uploads\/2022\/06\/image-1-616x1024.png 616w, https:\/\/nagekar.com\/wp-content\/uploads\/2022\/06\/image-1-181x300.png 181w, https:\/\/nagekar.com\/wp-content\/uploads\/2022\/06\/image-1.png 754w\" sizes=\"auto, (max-width: 616px) 100vw, 616px\" \/><\/figure>\n\n\n\n<p>Once the instance is created, log into the instance with SSH and update packages<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ apt update &amp;&amp; apt upgrade -y<\/code><\/pre>\n\n\n\n<p>Install Nginx<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo apt install nginx<\/code><\/pre>\n\n\n\n<p>Check what version of Nginx did we get from our package manager. This will be used when compiling Nginx later.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ nginx -v<\/code><\/pre>\n\n\n\n<p>I got the following output:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>nginx version: nginx\/1.18.0 (Ubuntu)<\/code><\/pre>\n\n\n\n<p>To make sure the webserver is successfully installed and running, simply visit the IP address of the server. It should look something similar to this:<\/p>\n\n\n\n<figure class=\"wp-block-image size-full\"><img loading=\"lazy\" decoding=\"async\" width=\"648\" height=\"230\" src=\"https:\/\/www.nagekar.com\/wp-content\/uploads\/2022\/06\/image-2.png\" alt=\"\" class=\"wp-image-1551\" srcset=\"https:\/\/nagekar.com\/wp-content\/uploads\/2022\/06\/image-2.png 648w, https:\/\/nagekar.com\/wp-content\/uploads\/2022\/06\/image-2-300x106.png 300w\" sizes=\"auto, (max-width: 648px) 100vw, 648px\" \/><\/figure>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"set-up-modsecurity\">Set up ModSecurity<\/h2>\n\n\n\n<p>First we&#8217;ll need to install compilation and other dependencies.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo apt-get install -y apt-utils autoconf automake build-essential git libcurl4-openssl-dev libgeoip-dev liblmdb-dev libpcre++-dev libtool libxml2-dev libyajl-dev pkgconf wget zlib1g-dev git<\/code><\/pre>\n\n\n\n<p>Next we&#8217;ll clone the ModSecurity repository into the \/opt directory<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ cd \/opt &amp;&amp; sudo git clone --recursive https:\/\/github.com\/SpiderLabs\/ModSecurity &amp;&amp; cd ModSecurity<\/code><\/pre>\n\n\n\n<p>Next we run the build script<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo .\/build.sh<\/code><\/pre>\n\n\n\n<p>Next we&#8217;ll run the compile script that will fetch all the dependencies for the compilation<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo .\/configure<\/code><\/pre>\n\n\n\n<p>It is possible that this command fails and reports you of any dependencies that are still missing. You can simply google them with &#8220;install XYZ on Ubuntu&#8221; and run the configure command again. Ideally it will just exit without any errors.<br>Next we start with the actual compilation of ModSecurity<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo make<\/code><\/pre>\n\n\n\n<p>A reason why I didn&#8217;t go with the smallest server was that this step is resource intensive and could take 15 minutes or more depending on your server&#8217;s CPU and memory.<\/p>\n\n\n\n<p>If all went through, we can now install ModSecurity<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo make install<\/code><\/pre>\n\n\n\n<p>If all went through without any errors, we have ModSecurity installed. <\/p>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"set-up-connector\">Set up ModSecurity &lt;-&gt; Nginx connector<\/h2>\n\n\n\n<p>We start off by downloading ModSecurity-Nginx and Nginx source code. <strong>Note that the version of Nginx in the next command must match the version installed on our system<\/strong>. For me, that&#8217;s  1.18.0 but it could be different for you.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ cd \/opt &amp;&amp; git clone https:\/\/github.com\/SpiderLabs\/ModSecurity-nginx.git\n$ cd \/opt &amp;&amp; sudo wget http:\/\/nginx.org\/download\/nginx-1.18.0.tar.gz<\/code><\/pre>\n\n\n\n<p>Untar the Nginx source. Replace the Nginx version in the next command if needed.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo tar -xvf nginx-1.18.0.tar.gz<\/code><\/pre>\n\n\n\n<p>Next, we need to grab configure arguments. For that, run the nginx command with a capital &#8216;V&#8217; flag.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ nginx -V\nnginx version: nginx\/1.18.0 (Ubuntu)\nbuilt with OpenSSL 1.1.1f  31 Mar 2020\nTLS SNI support enabled\n<strong>configure arguments: --with-cc-opt='-g -O2 -fdebug-prefix-map=\/build\/nginx-7KvRN5\/nginx-1.18.0=. -fstack-protector-strong -Wformat -Werror=format-security -fPIC -Wdate-time -D_FORTIFY_SOURCE=2' --with-ld-opt='-Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-z,now -fPIC' --prefix=\/usr\/share\/nginx --conf-path=\/etc\/nginx\/nginx.conf --http-log-path=\/var\/log\/nginx\/access.log --error-log-path=\/var\/log\/nginx\/error.log --lock-path=\/var\/lock\/nginx.lock --pid-path=\/run\/nginx.pid --modules-path=\/usr\/lib\/nginx\/modules --http-client-body-temp-path=\/var\/lib\/nginx\/body --http-fastcgi-temp-path=\/var\/lib\/nginx\/fastcgi --http-proxy-temp-path=\/var\/lib\/nginx\/proxy --http-scgi-temp-path=\/var\/lib\/nginx\/scgi --http-uwsgi-temp-path=\/var\/lib\/nginx\/uwsgi --with-debug --with-compat --with-pcre-jit --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_v2_module --with-http_dav_module --with-http_slice_module --with-threads --with-http_addition_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_sub_module --with-http_xslt_module=dynamic --with-stream=dynamic --with-stream_ssl_module --with-mail=dynamic --with-mail_ssl_module<\/strong><\/code><\/pre>\n\n\n\n<p>Note the &#8220;configure arguments&#8221; in the command&#8217;s output. We need to build modsecurity with these arguments.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo .\/configure --add-dynamic-module=..\/ModSecurity-nginx &lt;paste configure args here&gt;<\/code><\/pre>\n\n\n\n<p>For example, here&#8217;s what I&#8217;ll run:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo .\/configure --add-dynamic-module=..\/ModSecurity-nginx --with-cc-opt='-g -O2 -fdebug-prefix-map=\/build\/nginx-7KvRN5\/nginx-1.18.0=. -fstack-protector-strong -Wformat -Werror=format-security -fPIC -Wdate-time -D_FORTIFY_SOURCE=2' --with-ld-opt='-Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-z,now -fPIC' --prefix=\/usr\/share\/nginx --conf-path=\/etc\/nginx\/nginx.conf --http-log-path=\/var\/log\/nginx\/access.log --error-log-path=\/var\/log\/nginx\/error.log --lock-path=\/var\/lock\/nginx.lock --pid-path=\/run\/nginx.pid --modules-path=\/usr\/lib\/nginx\/modules --http-client-body-temp-path=\/var\/lib\/nginx\/body --http-fastcgi-temp-path=\/var\/lib\/nginx\/fastcgi --http-proxy-temp-path=\/var\/lib\/nginx\/proxy --http-scgi-temp-path=\/var\/lib\/nginx\/scgi --http-uwsgi-temp-path=\/var\/lib\/nginx\/uwsgi --with-debug --with-compat --with-pcre-jit --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_v2_module --with-http_dav_module --with-http_slice_module --with-threads --with-http_addition_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_sub_module --with-http_xslt_module=dynamic --with-stream=dynamic --with-stream_ssl_module --with-mail=dynamic --with-mail_ssl_module<\/code><\/pre>\n\n\n\n<p>Don&#8217;t copy the above command. You must use the configure arguments supplied by your installation of Nginx.<\/p>\n\n\n\n<p>Next we build the modules<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo make modules<\/code><\/pre>\n\n\n\n<p>This is a compilation step and may take a little while (a minute or so) to complete. The final step here is to copy the compiled modules to a place from where we can reference them from our Nginx config.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo mkdir \/etc\/nginx\/modules\n$ sudo cp objs\/ngx_http_modsecurity_module.so \/etc\/nginx\/modules<\/code><\/pre>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"load-modsecurity\">Loading ModSecurity module in Nginx<\/h2>\n\n\n\n<p>Simply add the following line to the nginx config file at <code>\/etc\/nginx\/nginx.conf<\/code> outside any block.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>load_module \/etc\/nginx\/modules\/ngx_http_modsecurity_module.so;<\/code><\/pre>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"set-up-crs\"><br>Set up OWASP Core Rule Set<\/h2>\n\n\n\n<p>OWASP&#8217;s Core Rule Set is a set of rules that cover most common frameworks and technologies as well as cover signatures for common web application attack payload. It is a good place to start if you don&#8217;t want to write custom rules for many common attacks.<\/p>\n\n\n\n<p>First, we&#8217;ll clone the modsecurity-crs repository<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo git clone https:\/\/github.com\/coreruleset\/coreruleset \/opt\/coreruleset<\/code><\/pre>\n\n\n\n<p>Then we&#8217;ll rename the crs-setup config file<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo mv \/opt\/coreruleset\/crs-setup.conf.example \/opt\/coreruleset\/crs-setup.conf<\/code><\/pre>\n\n\n\n<p>Activate the default exclusion rule file.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>sudo mv \/opt\/coreruleset\/rules\/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf.example \/opt\/coreruleset\/rules\/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf<\/code><\/pre>\n\n\n\n<p>Next we create a place for coreruleset to live within <code>\/etc\/nginx<\/code> and copy some additional config files.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo mkdir -p \/etc\/nginx\/modsec\n$ sudo cp \/opt\/ModSecurity\/unicode.mapping \/etc\/nginx\/modsec\n$ sudo cp \/opt\/ModSecurity\/modsecurity.conf-recommended \/etc\/nginx\/modsec\/modsecurity.conf<\/code><\/pre>\n\n\n\n<p>Next we create a config file that will include our main ModSecurity config file and CRS setup files.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo touch \/etc\/nginx\/modsec\/main.conf<\/code><\/pre>\n\n\n\n<p>And add the following lines to the config file.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>Include \/etc\/nginx\/modsec\/modsecurity.conf\nInclude \/opt\/coreruleset\/crs-setup.conf\nInclude \/opt\/coreruleset\/rules\/*.conf<\/code><\/pre>\n\n\n\n<p>Finally, we reference this main.conf file from our Nginx config.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>$ sudo vim \/etc\/nginx\/sites-available\/default<\/code><\/pre>\n\n\n\n<p>And add the following line within the server block.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>modsecurity on;\nmodsecurity_rules_file \/etc\/nginx\/modsec\/main.conf;<\/code><\/pre>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"turn-on-modsecurity\"><br>Turn ModSecurity &#8220;on&#8221; and test XSS payload<\/h2>\n\n\n\n<p>So far, we&#8217;ve configured everything but if we restart Nginx now, it won&#8217;t filter attacks but only detect them since the default operating mode of ModSecurity is to only log malicious requests. To change that, let&#8217;s open the file <code>\/etc\/nginx\/modsec\/modsecurity.conf<\/code> and change the line<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>SecRuleEngine DetectionOnly<\/code><\/pre>\n\n\n\n<p>to<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>SecRuleEngine On<\/code><\/pre>\n\n\n\n<p>For our changes to go live, we&#8217;ll need to restart Nginx.<\/p>\n\n\n\n<pre id=\"block-688d1141-18c0-45f4-8bf1-c008cd8526f1\" class=\"wp-block-code\"><code>$ sudo systemctl restart nginx<\/code><\/pre>\n\n\n\n<p>Let&#8217;s test our ModSecurity installation. Open your browser and send a sample payload in the GET parameter. It doesn&#8217;t have to be a real parameter, but just something that can trigger an XSS filter.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>http:&#47;&#47;&#91;server-ip]\/index.html?xss-payload=&lt;script&gt;alert(1)&lt;\/script&gt;<\/code><\/pre>\n\n\n\n<figure class=\"wp-block-image size-full\"><img loading=\"lazy\" decoding=\"async\" width=\"934\" height=\"206\" src=\"https:\/\/www.nagekar.com\/wp-content\/uploads\/2022\/06\/image-3.png\" alt=\"\" class=\"wp-image-1552\" srcset=\"https:\/\/nagekar.com\/wp-content\/uploads\/2022\/06\/image-3.png 934w, https:\/\/nagekar.com\/wp-content\/uploads\/2022\/06\/image-3-300x66.png 300w, https:\/\/nagekar.com\/wp-content\/uploads\/2022\/06\/image-3-768x169.png 768w\" sizes=\"auto, (max-width: 934px) 100vw, 934px\" \/><\/figure>\n\n\n\n<p>That&#8217;s ideal. ModSecurity is working and blocking seemingly malicious requests to our web server. Now any application that sits behind our web server will be protected against many generic web application attacks, even OWASP Top 10 thanks to OWASP&#8217;s CoreRuleSet. <\/p>\n\n\n\n<h2 class=\"wp-block-heading\">In conclusion<\/h2>\n\n\n\n<p>It isn&#8217;t the most straightforward of installations, but it isn&#8217;t very difficult either. The hard part, however, starts here and it is to get rid of all false positives and tweak the installation such that it fits the needs of your specific web application. Depending on how complex an application you&#8217;re trying to protect, it can be fairly time consuming.<\/p>\n\n\n\n<p>I&#8217;ll write an article on how to tweak the parameters of ModSecurity and make it fit our needs in the future in a separate article. <\/p>\n\n\n\n<p>That&#8217;s it for this article, thank you for reading! <\/p>\n","protected":false},"excerpt":{"rendered":"<p>ModSecurity is a web application firewall. It can protect your web application from preying eyes of vulnerability scanners and attackers. It is extremely customizable, and when paired with OWASP&#8217;s Core Rule Set, covers quite a lot of web technologies and frameworks. In this article, we&#8217;ll set up ModSecurity on an AWS EC2 Server running Nginx [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":1552,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[1],"tags":[203,29],"class_list":["post-1460","post","type-post","status-publish","format-standard","has-post-thumbnail","hentry","category-uncategorized","tag-security","tag-web"],"_links":{"self":[{"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/posts\/1460","targetHints":{"allow":["GET"]}}],"collection":[{"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/comments?post=1460"}],"version-history":[{"count":7,"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/posts\/1460\/revisions"}],"predecessor-version":[{"id":1561,"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/posts\/1460\/revisions\/1561"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/media\/1552"}],"wp:attachment":[{"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/media?parent=1460"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/categories?post=1460"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/nagekar.com\/wp-json\/wp\/v2\/tags?post=1460"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}